# Main CI Pipeline for MLC-LLM
#
# Pipeline order:
# 1. Lint - Code quality checks (advisory, non-blocking)
# 2. Build - Build wheels for Linux and Windows (in parallel)
# 3. Test - Run tests using built wheels

name: CI

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  # Allow manual trigger
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ===========================================================================
  # Stage 1: Lint - Code Quality Checks (Advisory)
  # ===========================================================================
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'

      - name: Install lint dependencies
        run: |
          python -m pip install --upgrade pip
          pip install black isort pylint mypy
          # Install minimal dependencies for linting
          pip install torch --index-url https://download.pytorch.org/whl/cpu
          pip install transformers fastapi uvicorn

      - name: Check formatting with Black
        id: black
        run: |
          black --diff --check \
            ./python/ \
            ./tests/python \
            ./examples/python
        continue-on-error: true

      - name: Check imports with isort
        id: isort
        run: |
          isort --check-only --profile black \
            ./python/ \
            ./tests/python/ \
            ./examples/python
        continue-on-error: true

      - name: Report formatting issues
        if: steps.black.outcome == 'failure' || steps.isort.outcome == 'failure'
        run: |
          echo "::warning::Code formatting issues detected"
          if [[ "${{ steps.black.outcome }}" == "failure" ]]; then
            echo "::warning::Black formatting issues found. Run 'black python/ tests/python examples/python' to fix"
          fi
          if [[ "${{ steps.isort.outcome }}" == "failure" ]]; then
            echo "::warning::isort issues found. Run 'isort python/ tests/python/ examples/python' to fix"
          fi

      - name: Lint with pylint
        run: |
          export PYTHONPATH="./python:${PYTHONPATH}"
          pylint --exit-zero --output-format=colorized ./python/ || true
        continue-on-error: true

      - name: Type check with mypy
        run: |
          export PYTHONPATH="./python:${PYTHONPATH}"
          mypy --ignore-missing-imports ./python/mlc_llm/ || true
        continue-on-error: true

  # ===========================================================================
  # Stage 2: Build - Build wheels (runs in parallel with lint)
  # ===========================================================================
  build-linux:
    name: Build Linux x64
    runs-on: ubuntu-22.04  # Use 22.04 for Vulkan SDK compatibility
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: 'recursive'
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            cmake \
            ninja-build \
            git \
            curl \
            wget \
            rustc \
            cargo \
            ccache \
            patchelf \
            llvm-dev \
            clang
          
      - name: Install Vulkan SDK
        run: |
          # Install LunarG Vulkan SDK which includes all required headers
          wget -qO- https://packages.lunarg.com/lunarg-signing-key-pub.asc | sudo tee /etc/apt/trusted.gpg.d/lunarg.asc
          sudo wget -qO /etc/apt/sources.list.d/lunarg-vulkan-jammy.list https://packages.lunarg.com/vulkan/lunarg-vulkan-jammy.list
          sudo apt-get update
          sudo apt-get install -y vulkan-sdk

      - name: Set up ccache
        uses: hendrikmuhs/ccache-action@v1.2
        with:
          key: linux-x64-build
          max-size: 2G

      - name: Install Python build dependencies
        run: |
          python -m pip install --upgrade pip
          pip install scikit-build-core ninja cmake auditwheel wheel patchelf

      - name: Configure CMake
        run: |
          mkdir -p build
          cat > config.cmake << 'EOF'
          set(USE_VULKAN ON)
          set(CMAKE_C_COMPILER_LAUNCHER ccache)
          set(CMAKE_CXX_COMPILER_LAUNCHER ccache)
          EOF
          cat config.cmake

      - name: Build wheel
        run: |
          export PATH="/usr/lib/ccache:$PATH"
          export CMAKE_BUILD_PARALLEL_LEVEL=$(nproc)
          pip wheel --no-deps -w dist . -v
        timeout-minutes: 60

      - name: Repair wheel with auditwheel
        run: |
          mkdir -p wheels
          auditwheel repair \
            --plat manylinux_2_31_x86_64 \
            --exclude libtvm \
            --exclude libtvm_runtime \
            --exclude libtvm_ffi \
            --exclude libvulkan \
            -w wheels/ \
            dist/*.whl || cp dist/*.whl wheels/
          ls -la wheels/

      - name: Upload wheel artifact
        uses: actions/upload-artifact@v4
        with:
          name: wheel-linux-x64
          path: wheels/*.whl
          retention-days: 30

  build-windows:
    name: Build Windows x64
    runs-on: windows-latest
    defaults:
      run:
        shell: cmd /C call {0}

    steps:
      - name: Git config
        run: git config --system core.longpaths true

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: 'recursive'
          fetch-depth: 0

      - name: Set up Conda environment
        uses: conda-incubator/setup-miniconda@v3
        with:
          activate-environment: mlc-llm-build
          channel-priority: strict
          environment-file: ci/build-environment.yaml
          auto-activate-base: false

      - name: Conda info
        run: |
          conda info
          conda list
          python --version

      - name: Install additional Python deps
        run: |
          pip install scikit-build-core ninja wheel

      - name: Configure CMake
        run: |
          mkdir build
          echo set(USE_VULKAN ON) > config.cmake
          type config.cmake

      - name: Build wheel
        run: |
          pip wheel --no-deps -w dist . -v
        timeout-minutes: 60

      - name: Move wheel to wheels directory
        shell: powershell
        run: |
          New-Item -ItemType Directory -Force -Path wheels
          Move-Item -Path dist\*.whl -Destination wheels\
          Get-ChildItem wheels

      - name: Upload wheel artifact
        uses: actions/upload-artifact@v4
        with:
          name: wheel-windows-x64
          path: wheels/*.whl
          retention-days: 30

  # ===========================================================================
  # Stage 3: Test - Run tests using built wheel
  # ===========================================================================
  test-linux:
    name: Test Linux
    runs-on: ubuntu-22.04
    needs: build-linux
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'

      - name: Download wheel artifact
        uses: actions/download-artifact@v4
        with:
          name: wheel-linux-x64
          path: wheels

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libvulkan1

      - name: Install wheel and test dependencies
        run: |
          python -m pip install --upgrade pip
          # Install TVM nightly from MLC wheels
          pip install --pre -U -f https://mlc.ai/wheels mlc-ai-nightly-cpu
          # Install the built wheel
          pip install wheels/*.whl --force-reinstall
          # Install test dependencies
          pip install pytest pytest-cov pytest-xdist
          pip install \
            datasets \
            fastapi \
            "ml_dtypes>=0.5.1" \
            openai \
            pandas \
            prompt_toolkit \
            requests \
            safetensors \
            sentencepiece \
            shortuuid \
            tiktoken \
            tqdm \
            transformers \
            uvicorn
          pip install torch --index-url https://download.pytorch.org/whl/cpu

      - name: Run unit tests
        run: |
          python -m pytest -v tests/python/ -m unittest \
            --ignore=tests/python/integration/ \
            --ignore=tests/python/op/ \
            --tb=short \
            -x || echo "::warning::Some tests failed"
        continue-on-error: true

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results-linux
          path: |
            .pytest_cache/
          retention-days: 7

  test-windows:
    name: Test Windows
    runs-on: windows-latest
    needs: build-windows
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'

      - name: Download wheel artifact
        uses: actions/download-artifact@v4
        with:
          name: wheel-windows-x64
          path: wheels

      - name: Install wheel and test dependencies
        run: |
          python -m pip install --upgrade pip
          # Install TVM nightly from MLC wheels
          pip install --pre -U -f https://mlc.ai/wheels mlc-ai-nightly-cpu
          # Install the built wheel
          pip install (Get-ChildItem wheels\*.whl).FullName --force-reinstall
          # Install test dependencies
          pip install pytest pytest-cov
          pip install datasets fastapi ml_dtypes openai pandas prompt_toolkit requests safetensors sentencepiece shortuuid tiktoken tqdm transformers uvicorn torch
        shell: powershell

      - name: Run unit tests
        run: |
          python -m pytest -v tests/python/ -m unittest --ignore=tests/python/integration/ --ignore=tests/python/op/ --tb=short -x
        continue-on-error: true
        shell: cmd

  # ===========================================================================
  # Summary job - Reports overall status
  # ===========================================================================
  ci-complete:
    name: CI Complete
    runs-on: ubuntu-latest
    needs: [lint, build-linux, build-windows, test-linux, test-windows]
    if: always()
    steps:
      - name: Check all jobs status
        run: |
          echo "Lint: ${{ needs.lint.result }}"
          echo "Build Linux: ${{ needs.build-linux.result }}"
          echo "Build Windows: ${{ needs.build-windows.result }}"
          echo "Test Linux: ${{ needs.test-linux.result }}"
          echo "Test Windows: ${{ needs.test-windows.result }}"
          
          # Lint failures are warnings, not blocking
          if [[ "${{ needs.lint.result }}" == "failure" ]]; then
            echo "::warning::Lint checks had issues (non-blocking)"
          fi
          
          # Build failures are critical
          if [[ "${{ needs.build-linux.result }}" == "failure" ]] || \
             [[ "${{ needs.build-windows.result }}" == "failure" ]]; then
            echo "::error::Build failed"
            exit 1
          fi
          
          # Test failures are warnings for now (tests may need GPU)
          if [[ "${{ needs.test-linux.result }}" == "failure" ]] || \
             [[ "${{ needs.test-windows.result }}" == "failure" ]]; then
            echo "::warning::Some tests failed (may require GPU or specific environment)"
          fi
          
          echo "CI completed!"
