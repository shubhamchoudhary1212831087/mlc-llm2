name: MLC-LLM Linux CI

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]
  workflow_dispatch:

env:
  REGISTRY: ghcr.io

jobs:
  build-docker:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    outputs:
      docker_image: ${{ steps.set-tag.outputs.image }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set Image Tag
        id: set-tag
        run: |
          REPO=$(echo "${{ github.repository }}" | tr '[:upper:]' '[:lower:]')
          echo "image=ghcr.io/$REPO:${{ github.sha }}" >> "$GITHUB_OUTPUT"

      - name: Build & Push
        uses: docker/build-push-action@v5
        with:
          context: .
          # Path to your Dockerfile (verify this path is correct in your repo)
          file: docker/docker/Dockerfile 
          push: true
          tags: ${{ steps.set-tag.outputs.image }}

  build-linux:
    needs: build-docker
    runs-on: ubuntu-latest
    container:
      image: ${{ needs.build-docker.outputs.docker_image }}
      options: --user root
    steps:
      # We do NOT checkout here because the Docker image already has the code and the .so built.
      # If you checkout, you will overwrite /mlc-llm and lose the built libraries.
      
      - name: Validate Installation
        run: |
          # Use the path where we installed everything in the Dockerfile
          cd /mlc-llm
          
          echo "--- Testing Import ---"
          python3 -c "import tvm; import mlc_llm; print('Success!')"
          
          echo "--- Testing CLI ---"
          mlc_llm chat -h

      - name: Export Wheels
        run: |
          # Copy the pre-built wheel from the docker build to the GH runner workspace
          cp /mlc-llm/python/dist/*.whl .

      - name: Upload Wheels
        uses: actions/upload-artifact@v4
        with:
          name: linux-wheels
          path: ./*.whl
