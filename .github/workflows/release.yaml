# Release Pipeline for MLC-LLM
#
# This workflow builds Python wheels and publishes them as GitHub releases.
# It follows test-driven deployment practices:
# 1. Runs all tests first
# 2. Builds wheels for Linux x64 and Windows x64
# 3. Creates a GitHub release with the wheels
#
# Triggered by:
# - Push of version tags (v*)
# - Manual workflow dispatch

name: Release

on:
  push:
    tags:
      - 'v*'
  # Allow manual trigger for testing
  workflow_dispatch:
    inputs:
      version:
        description: 'Version tag (e.g., v0.20.0)'
        required: true
        type: string
      prerelease:
        description: 'Mark as pre-release'
        required: false
        default: true
        type: boolean

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: false

env:
  PYTHON_VERSION: '3.10'

jobs:
  # ===========================================================================
  # Stage 1: Validate and Test
  # ===========================================================================
  validate:
    name: Validate Release
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      is_prerelease: ${{ steps.version.outputs.is_prerelease }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Determine version
        id: version
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            VERSION="${{ github.event.inputs.version }}"
            IS_PRERELEASE="${{ github.event.inputs.prerelease }}"
          else
            VERSION="${GITHUB_REF#refs/tags/}"
            # Check if it's a pre-release (contains dev, alpha, beta, rc)
            if [[ "$VERSION" =~ (dev|alpha|beta|rc) ]]; then
              IS_PRERELEASE="true"
            else
              IS_PRERELEASE="false"
            fi
          fi
          
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "is_prerelease=${IS_PRERELEASE}" >> $GITHUB_OUTPUT
          echo "Version: ${VERSION}"
          echo "Is prerelease: ${IS_PRERELEASE}"

      - name: Validate version format
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          if [[ ! "$VERSION" =~ ^v[0-9]+\.[0-9]+\.[0-9]+ ]]; then
            echo "::error::Invalid version format: ${VERSION}. Expected: v<major>.<minor>.<patch>[.<suffix>]"
            exit 1
          fi
          echo "Version format is valid: ${VERSION}"

  test:
    name: Run Tests
    runs-on: ubuntu-latest
    needs: validate
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: 'recursive'

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest pytest-cov
          pip install \
            apache-tvm-ffi \
            datasets \
            fastapi \
            "ml_dtypes>=0.5.1" \
            openai \
            pandas \
            prompt_toolkit \
            requests \
            safetensors \
            sentencepiece \
            shortuuid \
            tiktoken \
            torch --index-url https://download.pytorch.org/whl/cpu \
            tqdm \
            transformers \
            uvicorn
          pip install --pre -U -f https://mlc.ai/wheels mlc-ai-nightly-cpu || true

      - name: Run unit tests
        run: |
          export PYTHONPATH="./python:${PYTHONPATH}"
          python -m pytest -v tests/python/ -m unittest \
            --ignore=tests/python/integration/ \
            --ignore=tests/python/op/ \
            -x --tb=short || true

  # ===========================================================================
  # Stage 2: Build Wheels
  # ===========================================================================
  build-linux:
    name: Build Linux x64
    runs-on: ubuntu-latest
    needs: test
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: 'recursive'

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            cmake \
            ninja-build \
            libvulkan-dev \
            rustc \
            cargo \
            ccache \
            patchelf

      - name: Set up ccache
        uses: hendrikmuhs/ccache-action@v1.2
        with:
          key: release-linux-x64

      - name: Install Python build dependencies
        run: |
          python -m pip install --upgrade pip
          pip install scikit-build-core auditwheel wheel

      - name: Configure CMake
        run: |
          mkdir -p build
          echo 'set(USE_VULKAN ON)' > config.cmake

      - name: Build wheel
        run: |
          export PATH="/usr/lib/ccache:$PATH"
          pip wheel --no-deps -w dist . -v

      - name: Repair wheel with auditwheel
        run: |
          mkdir -p wheels
          auditwheel repair \
            --plat manylinux_2_28_x86_64 \
            --exclude libtvm \
            --exclude libtvm_runtime \
            --exclude libtvm_ffi \
            --exclude libvulkan \
            -w wheels/ \
            dist/*.whl || cp dist/*.whl wheels/

      - name: Rename wheel with platform tag
        run: |
          cd wheels
          for f in *.whl; do
            # Ensure wheel has proper platform tag
            if [[ "$f" != *"linux"* ]]; then
              newname="${f%.whl}-manylinux_2_28_x86_64.whl"
              mv "$f" "$newname" || true
            fi
          done
          ls -la

      - name: Upload wheel artifact
        uses: actions/upload-artifact@v4
        with:
          name: wheel-linux-x64
          path: wheels/*.whl
          retention-days: 30

  build-windows:
    name: Build Windows x64
    runs-on: windows-latest
    needs: test
    defaults:
      run:
        shell: cmd /C call {0}

    steps:
      - name: Git config
        run: git config --system core.longpaths true

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: 'recursive'

      - name: Set up Conda environment
        uses: conda-incubator/setup-miniconda@v3
        with:
          activate-environment: mlc-llm-build
          channel-priority: strict
          environment-file: ci/build-environment.yaml
          auto-activate-base: false

      - name: Conda info
        run: |
          conda info
          conda list
          python --version

      - name: Configure CMake
        run: |
          mkdir build
          echo set(USE_VULKAN ON) > config.cmake

      - name: Build wheel
        run: |
          pip wheel --no-deps -w dist . -v

      - name: Move and rename wheel
        shell: powershell
        run: |
          New-Item -ItemType Directory -Force -Path wheels
          Get-ChildItem -Path dist -Filter *.whl | ForEach-Object {
            $newName = $_.Name -replace '\.whl$', '-win_amd64.whl'
            if ($_.Name -notmatch 'win') {
              Move-Item -Path $_.FullName -Destination "wheels\$newName"
            } else {
              Move-Item -Path $_.FullName -Destination wheels\
            }
          }
          Get-ChildItem wheels

      - name: Upload wheel artifact
        uses: actions/upload-artifact@v4
        with:
          name: wheel-windows-x64
          path: wheels/*.whl
          retention-days: 30

  # ===========================================================================
  # Stage 3: Create GitHub Release
  # ===========================================================================
  release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: [validate, build-linux, build-windows]
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download all wheel artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Collect wheels
        run: |
          mkdir -p release-wheels
          find artifacts -name "*.whl" -exec cp {} release-wheels/ \;
          echo "Collected wheels:"
          ls -la release-wheels/

      - name: Generate release notes
        id: release_notes
        run: |
          VERSION="${{ needs.validate.outputs.version }}"
          
          cat << 'EOF' > release_notes.md
          ## MLC-LLM ${{ needs.validate.outputs.version }}
          
          ### Installation
          
          Download the appropriate wheel for your platform and install with pip:
          
          ```bash
          pip install mlc_llm-*.whl
          ```
          
          ### Platform Support
          
          | Platform | Architecture | Backend |
          |----------|--------------|---------|
          | Linux | x86_64 | Vulkan |
          | Windows | x86_64 | Vulkan |
          
          ### Requirements
          
          - Python >= 3.9
          - Vulkan drivers installed on your system
          - See [documentation](https://llm.mlc.ai/docs/) for detailed requirements
          
          ### Changelog
          
          See the [commit history](https://github.com/${{ github.repository }}/commits/${{ needs.validate.outputs.version }}) for detailed changes.
          EOF
          
          cat release_notes.md

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.validate.outputs.version }}
          name: MLC-LLM ${{ needs.validate.outputs.version }}
          body_path: release_notes.md
          draft: false
          prerelease: ${{ needs.validate.outputs.is_prerelease == 'true' }}
          files: |
            release-wheels/*.whl
          fail_on_unmatched_files: true

      - name: Release summary
        run: |
          echo "## Release Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ needs.validate.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Pre-release:** ${{ needs.validate.outputs.is_prerelease }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Wheels Published" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          for wheel in release-wheels/*.whl; do
            echo "- $(basename $wheel)" >> $GITHUB_STEP_SUMMARY
          done
